================================================================================
                    CLOUD FUNCTIONS ARCHITECTURE DIAGRAM
================================================================================

┌──────────────────────────────────────────────────────────────────────────┐
│                        EMAIL VERIFICATION FLOW                           │
└──────────────────────────────────────────────────────────────────────────┘

USER REGISTRATION
    │
    ▼
┌──────────────────────────────────────────┐
│         RegisterScreen                   │
│                                          │
│  • Email input                           │
│  • Password input                        │
│  • Role selection                        │
│  • Register button                       │
└──────────────────────────────────────────┘
    │
    ▼
┌──────────────────────────────────────────┐
│  EmailVerificationService                │
│  .sendVerificationCode(email)            │
│                                          │
│  1. Generate 6-digit code                │
│  2. Store in Firestore                   │
│  3. Call Cloud Function                  │
└──────────────────────────────────────────┘
    │
    ▼
┌──────────────────────────────────────────┐
│  Firebase Cloud Functions                │
│  sendVerificationEmail()                 │
│                                          │
│  • Validate email & code                 │
│  • Format HTML email                     │
│  • Call Nodemailer                       │
└──────────────────────────────────────────┘
    │
    ▼
┌──────────────────────────────────────────┐
│  Nodemailer                              │
│                                          │
│  • Connect to Gmail SMTP                 │
│  • Send email                            │
│  • Return result                         │
└──────────────────────────────────────────┘
    │
    ▼
┌──────────────────────────────────────────┐
│  Gmail SMTP Server                       │
│                                          │
│  • Receive email                         │
│  • Route to recipient                    │
│  • Deliver to inbox                      │
└──────────────────────────────────────────┘
    │
    ▼
┌──────────────────────────────────────────┐
│  User's Email Inbox                      │
│                                          │
│  ✓ Email received                        │
│  ✓ Code visible                          │
│  ✓ Ready for verification                │
└──────────────────────────────────────────┘

================================================================================
                        SYSTEM ARCHITECTURE
================================================================================

┌─────────────────────────────────────────────────────────────────────────┐
│                           FLUTTER APP                                   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐  │
│  │  RegisterScreen                                                 │  │
│  │  • Collects user data                                           │  │
│  │  • Validates input                                              │  │
│  │  • Calls EmailVerificationService                               │  │
│  └─────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐  │
│  │  EmailVerificationService                                       │  │
│  │  • Generates code                                               │  │
│  │  • Stores in Firestore                                          │  │
│  │  • Calls Cloud Function                                         │  │
│  └─────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐  │
│  │  EmailVerificationScreen                                        │  │
│  │  • Displays code input                                          │  │
│  │  • Shows timer                                                  │  │
│  │  • Verifies code                                                │  │
│  └─────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ HTTPS Call
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                    FIREBASE CLOUD FUNCTIONS                             │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐  │
│  │  sendVerificationEmail()                                        │  │
│  │                                                                 │  │
│  │  Input: { email, code }                                         │  │
│  │                                                                 │  │
│  │  1. Validate email format                                       │  │
│  │  2. Validate code format (6 digits)                             │  │
│  │  3. Create HTML email                                           │  │
│  │  4. Call Nodemailer                                             │  │
│  │  5. Return result                                               │  │
│  │                                                                 │  │
│  │  Output: { success: true, message: '...' }                      │  │
│  └─────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐  │
│  │  sendPasswordResetEmail()                                       │  │
│  │  • Future password reset feature                                │  │
│  └─────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐  │
│  │  sendWelcomeEmail()                                             │  │
│  │  • Future welcome email feature                                 │  │
│  └─────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ SMTP
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        GMAIL SMTP SERVER                                │
│                                                                         │
│  • Receive email from Cloud Function                                    │
│  • Authenticate with App Password                                       │
│  • Send to recipient                                                    │
│  • Deliver to inbox                                                     │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                      USER'S EMAIL INBOX                                 │
│                                                                         │
│  From: your-email@gmail.com                                             │
│  Subject: HealthSphere - Email Verification Code                        │
│  Body: Professional HTML with 6-digit code                              │
└─────────────────────────────────────────────────────────────────────────┘

================================================================================
                        DATA FLOW DIAGRAM
================================================================================

REGISTRATION FLOW:

User Input
    ↓
RegisterScreen validates
    ↓
EmailVerificationService.sendVerificationCode()
    ├─→ Generate code (100000-999999)
    ├─→ Store in Firestore
    │   └─→ email_verifications/{email}
    │       ├─ email: string
    │       ├─ code: string
    │       ├─ createdAt: timestamp
    │       ├─ expiresAt: timestamp
    │       ├─ verified: boolean
    │       └─ attempts: number
    │
    └─→ Call Cloud Function
        └─→ FirebaseFunctions.httpsCallable('sendVerificationEmail')
            ├─ Parameter: email
            ├─ Parameter: code
            └─ Return: { success: true }
                ↓
            Cloud Function
            ├─ Validate input
            ├─ Create HTML email
            ├─ Call Nodemailer
            └─ Send via Gmail SMTP
                ↓
            Gmail Server
            ├─ Authenticate
            ├─ Route email
            └─ Deliver to inbox
                ↓
            User's Inbox
            ├─ Email received
            ├─ Code visible
            └─ Ready for verification

VERIFICATION FLOW:

User enters code
    ↓
EmailVerificationScreen
    ├─ Get code from input fields
    └─ Call EmailVerificationService.verifyCode()
        ├─ Get document from Firestore
        ├─ Check if expired
        ├─ Check attempts remaining
        ├─ Compare codes
        └─ If valid:
            ├─ Mark as verified
            ├─ Return success
            └─ RegisterScreen creates account

================================================================================
                        SECURITY FLOW
================================================================================

CREDENTIALS SECURITY:

Gmail Credentials
    ↓
User's Gmail Account
    ├─ 2-Factor Authentication enabled
    └─ App Password generated
        ↓
    App Password (16 characters)
        ↓
    Firebase Environment Variable
        ├─ GMAIL_USER
        └─ GMAIL_APP_PASSWORD
            ↓
        Cloud Function
        ├─ Access credentials
        ├─ Connect to Gmail SMTP
        └─ Send email
            ↓
        Never exposed to:
        ├─ Flutter app
        ├─ Client-side code
        ├─ Git repository
        └─ Public logs

EMAIL VALIDATION:

Input: { email, code }
    ↓
Cloud Function validates
    ├─ Email format check
    │  └─ Regex: /^[^\s@]+@[^\s@]+\.[^\s@]+$/
    │
    └─ Code format check
       └─ Regex: /^\d{6}$/
           ↓
       Valid? → Send email
       Invalid? → Return error

================================================================================
                        ERROR HANDLING FLOW
================================================================================

Email Sending Error
    ↓
┌─────────────────────────────────────────┐
│  Cloud Function catches error           │
│                                         │
│  • Log error details                    │
│  • Return error response                │
└─────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────┐
│  EmailVerificationService catches error │
│                                         │
│  • Log error                            │
│  • Code still in Firestore              │
│  • Return code (for testing)            │
│  • Continue with verification           │
└─────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────┐
│  User can still verify                  │
│                                         │
│  • Code available in Firestore          │
│  • User can enter code manually         │
│  • Registration can complete            │
└─────────────────────────────────────────┘

================================================================================
                        DEPLOYMENT ARCHITECTURE
================================================================================

LOCAL DEVELOPMENT:

┌─────────────────────────────────────────┐
│  Flutter App (Debug)                    │
│  ├─ Emulator or physical device         │
│  └─ Points to local Firebase emulator   │
└─────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────┐
│  Firebase Emulator Suite                │
│  ├─ Cloud Functions emulator            │
│  ├─ Firestore emulator                  │
│  └─ Local testing                       │
└─────────────────────────────────────────┘

PRODUCTION DEPLOYMENT:

┌─────────────────────────────────────────┐
│  Flutter App (Release)                  │
│  ├─ App Store / Play Store              │
│  └─ Points to Firebase production       │
└─────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────┐
│  Firebase Cloud Functions (Production)  │
│  ├─ Deployed to Google Cloud            │
│  ├─ Scalable & reliable                 │
│  └─ 24/7 availability                   │
└─────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────┐
│  Gmail SMTP Server                      │
│  ├─ Google's email infrastructure       │
│  ├─ Reliable delivery                   │
│  └─ Spam filtering                      │
└─────────────────────────────────────────┘

================================================================================
                        MONITORING & LOGGING
================================================================================

Cloud Function Logs:

firebase functions:log
    ↓
Shows:
├─ Function execution time
├─ Memory usage
├─ Errors and warnings
├─ Custom log messages
└─ Request/response details

Example Log Output:

2024-11-26T19:30:45.123Z - sendVerificationEmail
  ✓ Email validation passed
  ✓ Code format valid
  ✓ HTML email created
  ✓ Nodemailer called
  ✓ Email sent to gonzagaprince919@gmail.com
  ✓ Function completed in 2.5s

================================================================================
                        PERFORMANCE METRICS
================================================================================

Typical Response Times:

Email Sending:
├─ Validation: ~10ms
├─ Email creation: ~50ms
├─ SMTP connection: ~200ms
├─ Email transmission: ~500ms
└─ Total: ~800ms (0.8 seconds)

Firestore Operations:
├─ Store code: ~100ms
├─ Retrieve code: ~50ms
├─ Update verification: ~100ms
└─ Total: ~250ms

Overall Registration:
├─ Code generation: ~10ms
├─ Firestore storage: ~100ms
├─ Cloud Function call: ~800ms
├─ Navigation: ~500ms
└─ Total: ~1.4 seconds

================================================================================
                            END OF DIAGRAMS
================================================================================
